#----------------------------------------------------------------------
# NOKIA MOBILE PHONES
# R&D Copenhagen
# TSS
#
#
#      Makefile for sig2macro (DSP 5.0 version)
#      ----------------------------------------
#      Makefile
#
# 
#
# Continuus DB:      co_pctls
# Project:           autogen
# Filename:          MakeSig2MacroDSP5
#
# Document code:      -
#
# Copyright (c) Nokia Corporation. All rights reserved.
#
# Change history:
#
# VERSION     : fa1prot#24 DRAFT      10-Oct-2009  Robert.J White
# REASON      : Improvement
# REFERENCE   : CM task fa1prot
# DESCRIPTION : Ensure generated dependencies only refer to files
#               generated by Sig2Macro.
#
# VERSION     : co1cdsp#23 DRAFT      08-Jan-2008  Fernando Casanova
# REASON      : Correction
# REFERENCE   : CM task co1cdsp#31305, co1cdsp#31266
# DESCRIPTION : Implemented workaround to fix tracing problems in RAPU
#               with DDI signal traces.
#
# VERSION     : fa1prot#22 DRAFT      13-Nov-2007  Robert.J White
# REASON      : Integration
# REFERENCE   : CM task fa1prot#82482
# DESCRIPTION : Updated for integration with modem sw development.
#
# VERSION     : fa1prot#21 DRAFT      23-May-2007  Robert.J White
# REASON      : Correction
# REFERENCE   : CM task fa1prot#68890
# DESCRIPTION : Correction to "Generate" message.
#
# VERSION     : fa1prot#20 DRAFT      09-May-2007  Robert.J White
# REASON      : Improvement
# REFERENCE   : CM task fa1prot#67874
# DESCRIPTION : Replace call to msg-Generate with generic msg function.
#               Updates to support SBT concept.
#
# VERSION     : fa1prot#19 DRAFT      24-Nov-2006  Robert.J White
# REASON      : Improvement
# REFERENCE   : CM task fa1prot#57315
# DESCRIPTION : Use impoved define_target-host_exe function.
#               Use DIRECTORY_TARGETS to create directories.
#
# VERSION     : fa1prot#18 DRAFT      02-Jun-2006  Robert White
# REASON      : Improvement
# REFERENCE   : CM task fa1prot#45032
# DESCRIPTION : Use DSP_RAP (DSP5) generic host executable rules to
#               build the tools.
#
# VERSION     : fa1prot#17 DRAFT      04-Aug-2005  Robert White
# REASON      : Improvement
# REFERENCE   : CM task fa1prot#26872
# DESCRIPTION : Build sig2macro files in autogen directory
#               (AUTOGEN_PATH).
#
# DESCRIPTION : Allow location of output files to be configured.
# VERSION     : fa1prot#16 DRAFT      06-May-2005  Robert White
# REASON      : Improvement
# REFERENCE   : CCM task fa1prot#23076
# DESCRIPTION : Allow location of output files to be configured.
#
# VERSION     : fa1prot#15 DRAFT      29-Nov-2004  Robert White
# REASON      : Correction
# REFERENCE   : CCM task fa1prot#14051
# DESCRIPTION : Ensure generated files are available for the
#               dependency list of autogenerated dependecies that
#               depend on the generated files (avoids NFS timing
#               problems when building with pvmgmake).
#
# VERSION     : fa1prot#14 DRAFT      05-Aug-2004  Robert White
# REASON      : Rewriten to fix many problems
# REFERENCE   : CCM task fa1prot#8694
# DESCRIPTION : Rewritten to fix dependency problems. Removes
#               unnecessary building of the targets.
#
# VERSION     : fa1prot#13 DRAFT      14-Jul-2004  Robert White
# REASON      : Improvement
# REFERENCE   : CCM task fa1prot#8013
# DESCRIPTION : Separate generated files from checked-in files and implement
#               cleaning of generated files.
#
# VERSION     : fa1prot#12 DRAFT      13-Jul-2004  Robert White
# REASON      : Rewrite
# REFERENCE   : CCM task fa1prot#8013
# DESCRIPTION : Rewritten to support parallel building and autogenerated
#               dependencies.  Also some fixes for clean.
#
# VERSION     : fa1prot#10 DRAFT      23-Jun-2004  Robert White
# REASON      : Bug fix
# REFERENCE   : CCM task fa1prot#7325
# DESCRIPTION : Use variable reference rather then hard coded path to 
#               sig2macro.c
# VERSION     : 10          DRAFT      07-Jun-2004  Christian J. Hansen
# REASON      : Merge of 7 and so_prot#9
# REFERENCE   : -
# DESCRIPTION : -
#
# VERSION     : so_prot#8  DRAFT      26-May-2004  Haleema Hameed
# REASON      : Bug fix
# REFERENCE   : -
# DESCRIPTION : Use GCC instead of CC
#
# VERSION     : 7          DRAFT      25-May-2004  Christian J. Hansen
# REASON      : Improvements
# REFERENCE   : -
# DESCRIPTION : Add include paths
#
# VERSION     : so_prot#7  DRAFT      04-Feb-2004  Jussi Tohmola
# REASON      : Bug fix
# REFERENCE   : -
# DESCRIPTION : - Quick fixes to solve Gandalf PMD generation problems:
#                * Used /usr/include path instead of Lead3 tool include
#                  path in compilation commands.
#                * Used gcc as compiler instead of cc.
#
# VERSION     : 6          DRAFT      20-Jan-2004  Jussi Tohmola
# REASON      : Bug fix
# REFERENCE   : -
# DESCRIPTION : Removed cc compilation flag -Aa to get macro generation working also on Linux
#
# VERSION     : 5          DRAFT      07-Jan-2004  Ilkka Makela
# REASON      : Bug fix
# REFERENCE   : -
# DESCRIPTION : Added "" around CDSP SW version string
#
# VERSION     : 4          DRAFT      26-Nov-2003  Christian J. Hansen
# REASON      : Improvement
# REFERENCE   : -
# DESCRIPTION : Changed compiler option
#
# VERSION     : 3          DRAFT      29-Oct-2003  Christian J. Hansen
# REASON      : Integration
# REFERENCE   : -
# DESCRIPTION : Add CDSP version as argument
#
# VERSION     : 2          DRAFT      29-Jul-2003  Christian J. Hansen
# REASON      : Integration
# REFERENCE   : -
# DESCRIPTION : Change paths
#
# VERSION     : 1          DRAFT      08-Apr-2003  Christian J. Hansen
# REASON      : First version
# REFERENCE   : -
# DESCRIPTION : -
#----------------------------------------------------------------------

# paths/files
OUTPUT_PATH		?= $(TOPDIR)/common_files/ISA_servers
OUTPUT_FILE		?= dsp5_sig_trc_m.h
MACRO_PATH		?= $(TOPDIR)/common_files/ISA_servers/generated_sig2macro

SIG2MACRO_SRCS		:= sig2macro.c \
			   generate_dsp5_signal_ids.c

SIG2MACRO_EXE		:= $(ARCH)/$(AUTOGEN_PATH)/$(patsubst %.c,%.exe,$(firstword $(SIG2MACRO_SRCS)))

SIG2MACRO_DEFINES	+= -DSIG2MACRO_DSP5

SIG2MACRO_EXCLUDE = ddi_msg.sig

.PHONY: Sig2Macro
Sig2Macro: $(OUTPUT_PATH)/$(OUTPUT_FILE)

PREREQS-Sig2Macro	+= $(OUTPUT_PATH)/$(OUTPUT_FILE)


# This target executes the SIG2MACRO_EXE tool to generate files.
# Dependencies are also created for the generated files in the
# $(SIG2MACRO_EXE).generated_files.d file.  These dependencies are used
# to ensure the headers are regenerated if any of them go missing.
$(OUTPUT_PATH)/$(OUTPUT_FILE): $(SIG2MACRO_EXE) $(SIG2MACRO_EXE).generated_files.d $(MACRO_PATH)/.mkdir $(OUTPUT_PATH)/.mkdir
	$(call msg,Generate,$@ $(MACRO_PATH)/... $<.log,using: $<) && \
	rm -f $@ $(MACRO_PATH)/* $<.log $<.generated_files.d $<.generated_files.d.1 && \
	{ \
		$(dir $<)$(notdir $<) -m$(MACRO_PATH) \
			-o$@ \
			-v"$(CDSP_SW_VERSION_STRING)" \
			-e$(SIG2MACRO_EXCLUDE) || \
		rm -f $@; \
	} $(if $(call if-debug,v),| tee,>) $<.log && \
	[ -r $@ ] && \
	find $(MACRO_PATH) -mindepth 1 \
		! -type d ! -name '.*' \
		-exec echo "$@ :" {} \; -exec echo {} ":" \; > $<.generated_files.d.1 && \
	mv $<.generated_files.d.1 $<.generated_files.d && \
	touch $@

PREREQS-$(OUTPUT_PATH)/$(OUTPUT_FILE)	+= $(SIG2MACRO_EXE) $(MACRO_PATH) $(OUTPUT_PATH)


-include $(SIG2MACRO_EXE).generated_files.d

$(SIG2MACRO_EXE).generated_files.d: ;


# Define the host executable target rule.
$(call define-host_exe, \
	$(SIG2MACRO_EXE), \
	$(addprefix $(AUTOGEN_PATH)/,$(SIG2MACRO_SRCS)), \
	$(SIG2MACRO_EXTERNAL_PREREQS) \
)

# Add in some Sig2Macro specific defines and include paths.
$(SIG2MACRO_EXE): IPATH += $(SIG2MACRO_INCLUDEPATH)
$(SIG2MACRO_EXE): DEFS  += $(SIG2MACRO_DEFINES)


# Clean all files generated during the Sig2Macro process.
clean: clean-Sig2Macro

.PHONY: clean-Sig2Macro
clean-Sig2Macro:
	rm -f $(SIG2MACRO_EXE).generated_files.d \
	      $(OUTPUT_PATH)/$(OUTPUT_FILE) \
	      $(MACRO_PATH)/*

